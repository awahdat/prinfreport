---
import Layout from '@layouts/Default.astro';
import RecentBlogPosts from '@components/generic/RecentBlogPosts.astro';
import MobileSocials from '@components/home/MobileSocials.astro';
import { Pill } from '@eliancodes/brutal-ui';
import { Button } from '@eliancodes/brutal-ui';
import { Card } from '@eliancodes/brutal-ui';
---

<Layout
  title='Price Inflation Report'
  pageTitle='Price Inflation Report | Understanding Price Changes in America'
  description='Help Americans understand changing prices in the economy and daily life with clear inflation data and personal impact calculators.'
>
  <main class='bg-pink p-6'>
    <section class='grid grid-cols-1 gap-8 mt-4'>
      <!-- Header -->
      <Card>
        <h1 class='text-5xl md:text-7xl mb-4'>Price Inflation Report</h1>
        <p class='text-xl md:text-2xl mb-2'>
          To help Americans understand the changing prices in the economy and in their daily life.
        </p>
        <p class='text-base md:text-lg text-gray-600'>
          <strong>How fast are your prices rising?</strong> Enter your monthly expenses below to see your personal inflation.
        </p>
      </Card>

      <!-- What is Inflation -->
      <Card>
          <h2 class='text-3xl md:text-5xl mb-4'>What is Inflation?</h2>
          <p class='text-lg md:text-xl mb-4'>
            Inflation is the <strong>rate</strong> at which prices increase over time. Think of it like the speedometer in your carâ€”it tells you how fast you're going, not how far you've traveled. Similarly, inflation tells you how quickly prices are rising, not how expensive things are overall.
          </p>
          <p class='text-lg md:text-xl mb-4'>
            A 3% annual inflation rate means that something costing $100 today would cost $103 in a year. The key word is "rate"â€”it's about the <em>speed of change</em>, not the price level itself. Even if prices are high, if inflation is 0%, prices aren't changing. Conversely, even if prices are low, 10% inflation means they're rising rapidly.
          </p>
          <p class='text-lg md:text-xl'>
            We show both <strong>monthly</strong> inflation (how prices changed from last month) and <strong>annual</strong> inflation (how prices changed over the past year). Monthly rates are typically smaller but more volatile; annual rates give a better sense of the overall trend.
          </p>
      </Card>


      <!-- Visualization -->
      <Card class="bg-[#ebf8ff]">
        <h2 class='text-3xl md:text-5xl mb-6'>Price Changes by Category</h2>
        <div id="reportDate" class='text-lg'></div>
        <div id="inflationChart" style='width: 100%; overflow-x: auto;'></div>
      </Card>

      <!-- Personal Calculator -->
      <Card>
        <h2 class='text-3xl md:text-5xl mb-4'>Calculate Your Personal Inflation</h2>
        <div style='background: #f0fff4; border-left: 4px solid #48bb78; padding: 15px; margin-bottom: 20px;'>
          <p class='text-base'>
            <strong>ðŸ”’ Privacy Notice:</strong> We won't store or sell the spending data you enter for calculating the impact of inflation on you.
          </p>
        </div>
        <p class='text-lg mb-6' id="calculatorDesc"></p>
        
        <div id="expenseForm" style='gap: 15px; margin-bottom: 20px;'></div>
        
        <button 
          onclick="calculateImpact()" 
          class='btn btn-primary w-full'
          style='background: #4299e1; color: white; padding: 15px 30px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; width: 100%;'
        >
          Calculate My Inflation Impact
        </button>

        <!-- Personal Inflation Summary (NEW) -->
        <div id="personalInflationSummary"></div>

        <div id="results"></div>
      </Card>

      <!-- Email Signup -->
      <Card>
          <h2 class='text-3xl md:text-5xl mb-4'>ðŸ“§ Stay Informed</h2>
          <p class='text-lg mb-6'>
            Get notified when each new Price Inflation Report is released monthly.
          </p>
          <div style='display: flex; flex-direction: column; gap: 10px;'>
            <input 
              type="email" 
              id="emailInput" 
              placeholder="Enter your email" 
              style='padding: 15px; border: none; border-radius: 6px; font-size: 1rem; color: #333;'
            />
            <button 
              onclick="submitEmail()" 
              style='background: white; color: #667eea; padding: 15px 30px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 1rem;'
            >
              Sign Up
            </button>
          </div>
      </Card>

      <!-- Share Data Survey -->
      <Card>
          <h2 class='text-3xl md:text-5xl mb-4'>
            Help Build Americaâ€™s Personal Inflation Story
          </h2>

          <p class='text-lg mb-4'>
            Price changes donâ€™t affect everyone the same way. By answering a few quick questions,
            we will tell you each month how price inflation is showing up in American households.
          </p>

            <div style='background:#f0fff4;border-left:4px solid #48bb78;padding:15px;margin-bottom:20px;'>
              <p class='text-base'>
                <strong>ðŸ”’ Trust & Privacy:</strong>
                Your responses will be anonymous and combined with responses from other Americans across the country to show national patterns.
              </p>
            </div>
          
          <!-- Survey Questions -->
          <div style='display: flex; flex-direction: column; gap: 24px; margin-bottom: 20px;'>
            
            <!-- Question 1: ZIP Code -->
            <div>
              <label style='display: block; margin-bottom: 8px; font-weight: 600; font-size: 1rem;'>
                1. ZIP Code *
              </label>
              <input 
                type="text" 
                id="survey_zipcode" 
                placeholder="12345" 
                maxlength="5"
                required
                style='width: 100%; max-width: 300px; padding: 12px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 1rem;'
              />
            </div>

            <!-- Question 2: Spending Change -->
            <div>
              <label style='display: block; margin-bottom: 8px; font-weight: 600; font-size: 1rem;'>
                2. Compared to last month, how did your total spending change due to price changes? *
              </label>
              <select 
                id="survey_spending_change"
                required
                style='width: 100%; max-width: 400px; padding: 12px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 1rem;'
              >
                <option value="">Select an option</option>
                <option value="Went Up">Went Up</option>
                <option value="Stayed the Same">Stayed the Same</option>
                <option value="Went Down">Went Down</option>
                <option value="Don't Know">Don't Know</option>
              </select>
            </div>

            <!-- Question 3: Category with Most Increase -->
            <div>
              <label style='display: block; margin-bottom: 8px; font-weight: 600; font-size: 1rem;'>
                3. As a result of price changes, which category's spending increased the most for you this month? *
              </label>
              <select 
                id="survey_category_increase"
                required
                style='width: 100%; max-width: 400px; padding: 12px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 1rem;'
              >
                <option value="">Select a category</option>
                <option value="Housing / Rent">Housing / Rent</option>
                <option value="Food & Groceries">Food & Groceries</option>
                <option value="Transportation">Transportation</option>
                <option value="Medical Care">Medical Care</option>
                <option value="Utilities">Utilities</option>
                <option value="Education & Childcare">Education & Childcare</option>
                <option value="Clothing & Shoes">Clothing & Shoes</option>
                <option value="Other Goods & Services">Other Goods & Services</option>
              </select>
            </div>

            <!-- Question 4: Can Cover Expenses -->
            <div>
              <label style='display: block; margin-bottom: 8px; font-weight: 600; font-size: 1rem;'>
                4. Given your recent monthly income and price changes, can you cover your monthly expenses? *
              </label>
              <select 
                id="survey_cover_expenses"
                required
                style='width: 100%; max-width: 400px; padding: 12px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 1rem;'
              >
                <option value="">Select an option</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
                <option value="Don't Know">Don't Know</option>
              </select>
            </div>

            <!-- Question 5: Future Expectations -->
            <div>
              <label style='display: block; margin-bottom: 8px; font-weight: 600; font-size: 1rem;'>
                5. Over the next 3 months, do you expect prices in general will go up, go down, or stay where they are now? *
              </label>
              <select 
                id="survey_price_expectations"
                required
                style='width: 100%; max-width: 400px; padding: 12px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 1rem;'
              >
                <option value="">Select an option</option>
                <option value="Go Up">Go Up</option>
                <option value="Stay the Same">Stay the Same</option>
                <option value="Go Down">Go Down</option>
                <option value="Don't Know">Don't Know</option>
              </select>
            </div>

          </div>
          
          <button 
            onclick="submitSurvey()"
            style='background: #ed8936; color: white; padding: 15px 30px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; width: 100%;'
          >
            Submit Survey
          </button>
      </Card>

      <!-- Footer -->
      <Card>
        <div style='text-align: center; color: #000000;'>
          <p class='text-base'>Data source: U.S. Bureau of Labor Statistics (BLS)</p>
          <p class='text-base mt-2'>Updated monthly when new CPI data is released</p>
        </div>
      </Card>
    </section>
  </main>
</Layout>

<script is:inline src="https://cdn.jsdelivr.net/npm/vega@6"></script>
<script is:inline src="https://cdn.jsdelivr.net/npm/vega-lite@6"></script>
<script is:inline src="https://cdn.jsdelivr.net/npm/vega-embed@7"></script>

<script is:inline>
  // CPI Categories to display (matching BLS table names)
  const categoryMapping = {
    'All items': 'All Items',
    'Housing': 'Housing',
    'Food and Beverages': 'Food and Beverages',
    'Transportation': 'Transportation',
    'Medical Care': 'Medical Care',
    'Education': 'Education',
    'Communication': 'Communication',
    'Recreation': 'Recreation',
    'Apparel': 'Apparel',
    'Other Goods and Services': 'Other Goods and Services'
  };

  let cpiData = null;

  // Initialize function
  function initializePage() {
    loadMockData();
  }

  // Run on initial load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializePage);
  } else {
    initializePage();
  }

  // Re-run when navigating back to this page (for SPA routing)
  document.addEventListener('astro:page-load', initializePage);

  // Re-render chart on window resize for responsive behavior
  let resizeTimeout;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function() {
      if (cpiData) {
        renderChart();
      }
    }, 250);
  });

  function loadMockData() {
    useMockData();
  }

  function useMockData() {
    cpiData = {
      reportDate: 'January 25, 2026',
      reportMonth: 'December 2025',
      previousMonth: 'November',
      previousYear: 'December 2024',
      categories: {
        'All Items': { monthly: 0.3, annual: 2.7 },
        'Housing': { monthly: 0.4, annual: 3.6 },
        'Food and Beverages': { monthly: 0.7, annual: 3.0 },
        'Transportation': { monthly: 0.0, annual: 0.4 },
        'Medical Care': { monthly: 0.4, annual: 3.2 },
        'Education': { monthly: 0.2, annual: 2.9 },
        'Communication': { monthly: -1.9, annual: -1.5 },
        'Recreation': { monthly: 1.2, annual: 3.0 },
        'Apparel': { monthly: 0.6, annual: 0.6 },
        'Other Goods and Services': { monthly: 0.3, annual: 4.2 }
      }
    };
    renderPage();
  }

  function renderPage() {
    // Update report date
    document.getElementById('reportDate').innerHTML = 
      `ðŸ“… Latest Report: ${cpiData.reportMonth} (Released ${cpiData.reportDate}). Note that All Items category refers to the total basket of goods and services that households buy.`;
    
    document.getElementById('calculatorDesc').innerHTML = 
      `Enter your monthly spending for ${cpiData.reportMonth} in any categories below to see what those expenses would have cost in ${cpiData.previousMonth} and ${cpiData.previousYear}.`;

    // Render expense forms
    renderExpenseForms();
    
    // Render Vega chart
    renderChart();
  }

  function renderExpenseForms() {
    const expenseForm = document.getElementById('expenseForm');
    
    expenseForm.innerHTML = '';
    
    // Use categories from the fetched data
    const categories = Object.keys(cpiData.categories).filter(category => category !== 'All Items');

    categories.forEach(category => {
      // Personal calculator form
      const div1 = document.createElement('div');
      div1.className = 'expense-item';
      div1.dataset.category = category;
      div1.style.cssText = 'gap: 5px;';
      div1.innerHTML = `
        <label style='font-weight: 500; font-size: 0.95rem;'>${category}</label>
        <div style='position: relative; max-width: 300px;'>
          <span style='position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #718096; font-size: 1.1rem;'>$</span>
          <input 
            type="number" 
            id="exp_${category.replace(/\s+/g, '_')}" 
            min="0" 
            step="0.01" 
            placeholder="0.00"
            style='width: 100%; padding: 12px 12px 12px 28px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 1.1rem;'
          />
        </div>
      `;
      expenseForm.appendChild(div1);
    });
  }

  function renderChart() {
    console.log('renderChart called');
    
    // Check if vegaEmbed is available
    if (typeof vegaEmbed === 'undefined') {
      console.error('vegaEmbed is not loaded');
      setTimeout(renderChart, 100);
      return;
    }

    // Prepare data for grouped bar chart
    const chartData = [];
    
    Object.entries(cpiData.categories).forEach(([category, data]) => {
      chartData.push({
        category: category,
        type: 'Monthly',
        value: data.monthly
      });
      chartData.push({
        category: category,
        type: 'Annual',
        value: data.annual
      });
    });

    console.log('Chart data prepared:', chartData);

    // Determine width based on screen size
    const isMobile = window.innerWidth < 768;
    const chartWidth = isMobile ? 600 : 900;
    const chartHeight = isMobile ? 900 : 650;

    const vegaSpec = {
      "$schema": "https://vega.github.io/schema/vega/v6.json",
      "background": "white",
      "autosize": {"type": "fit-x", "contains": "padding"},
      "width": chartWidth,
      "height": chartHeight,
      "padding": 5,
      "data": [
        {
          "name": "table",
          "values": chartData
        }
      ],
      "scales": [
        {
          "name": "yscale",
          "type": "band",
          "domain": {"data": "table", "field": "category"},
          "range": "height",
          "padding": 0.15
        },
        {
          "name": "xscale",
          "type": "linear",
          "domain": {"data": "table", "field": "value"},
          "range": "width",
          "nice": true,
          "zero": true
        },
        {
          "name": "color",
          "type": "ordinal",
          "domain": ["Monthly", "Annual"],
          "range": ["#6366f1", "#8b5cf6"]
        }
      ],
      "axes": [
        {
          "orient": "bottom",
          "scale": "xscale",
          "title": "% Change",
          "titleFontSize": isMobile ? 14 : 16,
          "labelFontSize": isMobile ? 12 : 14
        },
        {
          "orient": "left",
          "scale": "yscale",
          "labelFontSize": isMobile ? 11 : 14
        }
      ],
      "legends": [
        {
          "fill": "color",
          "title": "Period",
          "orient": "top-right",
          "titleFontSize": isMobile ? 14 : 16,
          "labelFontSize": isMobile ? 12 : 14
        }
      ],
      "marks": [
		// ADD THIS WATERMARK GROUP FIRST
	    {
	      "type": "group",
	      "encode": {
	        "update": {
	          "x": {"value": 10},
	          "y": {"value": 10}
	        }
	      },
	      "marks": [
	        {
	          "type": "text",
	          "encode": {
	            "update": {
	              "x": {"value": 0},
	              "y": {"value": 0},
	              "text": {"value": "Price"},
	              "fontSize": {"value": isMobile ? 16 : 20},
	              "fontWeight": {"value": "bold"},
	              "fill": {"value": "#000000"},
	              "fillOpacity": {"value": 0.15}
	            }
	          }
	        },
	        {
	          "type": "text",
	          "encode": {
	            "update": {
	              "x": {"value": 0},
	              "y": {"value": isMobile ? 18 : 22},
	              "text": {"value": "Inflation"},
	              "fontSize": {"value": isMobile ? 16 : 20},
	              "fontWeight": {"value": "bold"},
	              "fill": {"value": "#000000"},
	              "fillOpacity": {"value": 0.15}
	            }
	          }
	        },
	        {
	          "type": "text",
	          "encode": {
	            "update": {
	              "x": {"value": 0},
	              "y": {"value": isMobile ? 36 : 44},
	              "text": {"value": "Report"},
	              "fontSize": {"value": isMobile ? 16 : 20},
	              "fontWeight": {"value": "bold"},
	              "fill": {"value": "#718096"},
	              "fillOpacity": {"value": 0.15}
	            }
	          }
	        },
	        {
	          "type": "symbol",
	          "encode": {
	            "update": {
	              "x": {"value": isMobile ? 60 : 75},
	              "y": {"value": isMobile ? 36 : 44},
	              "size": {"value": isMobile ? 30 : 50},
	              "shape": {"value": "circle"},
	              "fill": {"value": "#ef4444"},
	              "fillOpacity": {"value": 0.2}
	            }
	          }
	        },
	        {
	          "type": "text",
	          "encode": {
	            "update": {
	              "x": {"value": 0},
	              "y": {"value": isMobile ? 52 : 62},
	              "text": {"signal": "'Data: ' + '" + cpiData.reportMonth + "'" },
	              "fontSize": {"value": isMobile ? 10 : 12},
	              "fill": {"value": "#718096"},
	              "fillOpacity": {"value": 0.2}
	            }
	          }
	        }
	      ]
	    },
		// rest of your existing marks (the group with bars)
        {
          "type": "group",
          "from": {
            "facet": {
              "data": "table",
              "name": "facet",
              "groupby": "category"
            }
          },
          "encode": {
            "enter": {
              "y": {"scale": "yscale", "field": "category"}
            }
          },
          "signals": [
            {"name": "height", "update": "bandwidth('yscale')"}
          ],
          "scales": [
            {
              "name": "pos",
              "type": "band",
              "range": "height",
              "domain": {"data": "facet", "field": "type"},
              "padding": 0.15
            }
          ],
          "marks": [
            {
              "type": "rect",
              "from": {"data": "facet"},
              "encode": {
                "enter": {
                  "y": {"scale": "pos", "field": "type"},
                  "height": {"scale": "pos", "band": 1},
                  "x": {"scale": "xscale", "value": 0},
                  "x2": {"scale": "xscale", "field": "value"},
                  "fill": {"scale": "color", "field": "type"}
                },
                "update": {
                  "fillOpacity": {"value": 0.9}
                },
                "hover": {
                  "fillOpacity": {"value": 1}
                }
              }
            },
            {
              "type": "text",
              "from": {"data": "facet"},
              "encode": {
                "enter": {
                  "y": {"scale": "pos", "field": "type", "band": 0.5},
                  "x": {"scale": "xscale", "field": "value", "offset": 5},
                  "fill": {"value": "#000"},
                  "baseline": {"value": "middle"},
                  "text": {"signal": "format(datum.value, '.1f') + '%'"},
                  "fontSize": {"value": isMobile ? 12 : 14},
                  "fontWeight": {"value": "bold"}
                }
              }
            }
          ]
        }
      ]
    };

    console.log('Calling vegaEmbed');
    vegaEmbed('#inflationChart', vegaSpec, {
      renderer: 'svg',
      actions: {
        export: true,
        source: false,
        editor: false
      }
    })
      .then(() => console.log('Chart rendered successfully'))
      .catch(err => console.error('Chart rendering error:', err));
  }

  function calculateImpact() {
    const results = {};
    let hasData = false;
    
    const categories = Object.keys(cpiData.categories).filter(category => category !== 'All Items');

    categories.forEach(category => {
      const id = 'exp_' + category.replace(/\s+/g, '_');
      const value = parseFloat(document.getElementById(id).value);
      
      if (value && value > 0) {
        hasData = true;
        const categoryData = cpiData.categories[category];
        const monthlyChange = categoryData.monthly / 100;
        const annualChange = categoryData.annual / 100;

        results[category] = {
          current: value,
          lastMonth: value / (1 + monthlyChange),
          lastYear: value / (1 + annualChange),
          monthlyChange: categoryData.monthly,
          annualChange: categoryData.annual
        };
      }
    });

    if (!hasData) {
      alert('Please enter at least one expense amount.');
      return;
    }

    displayResults(results);
  }

  function calculatePersonalInflation(results) {
    let totalSpending = 0;
    let weightedInflation = 0;
    let categoryCount = 0;
  
    Object.entries(results).forEach(([category, data]) => {
      const spending = data.current;
      const inflationRate = cpiData.categories[category].annual;
  
      totalSpending += spending;
      weightedInflation += spending * inflationRate;
      categoryCount++;
    });
  
    const personalInflation = weightedInflation / totalSpending;
    const nationalInflation = cpiData.categories["All Items"].annual;
    const gap = personalInflation - nationalInflation;
  
    return {
      personalInflation,
      nationalInflation,
      gap,
      categoryCount,
      totalCategories: Object.keys(cpiData.categories).length
    };
  }

  function displayResults(results) {
    const summary = calculatePersonalInflation(results);
    
    const gapText =
      summary.gap > 0
        ? `<span style="color:#c53030;font-weight:600;">${summary.gap.toFixed(1)} percentage points higher</span>`
        : summary.gap < 0
        ? `<span style="color:#2f855a;font-weight:600;">${Math.abs(summary.gap).toFixed(1)} percentage points lower</span>`
        : `<span style="font-weight:600;">about the same as</span>`;
    
    document.getElementById('personalInflationSummary').innerHTML = `
      <div style="background:#ebf8ff;border-left:4px solid #4299e1;padding:20px;margin-top:30px;border-radius:8px;">
        <h3 style="font-size:1.6rem;margin-bottom:10px;">Your Personal Inflation</h3>
        <p style="font-size:1.05rem;">
          Your estimated inflation is <strong>${summary.personalInflation.toFixed(1)}%</strong>,
          which is ${gapText} the national average inflation of
          <strong>${summary.nationalInflation.toFixed(1)}%</strong>.
        </p>
        <p style="font-size:0.9rem;color:#4a5568;margin-top:8px;">
          This estimation is based on ${summary.categoryCount} of ${summary.totalCategories} categories entered. Your personal inflation differs because you spend more or less than
        the average household on certain categories.
        </p>
      </div>
    `;

    const resultsDiv = document.getElementById('results');
    let html = '<h3 style="margin-top: 30px; border-top: 2px solid #e2e8f0; padding-top: 30px; font-size: 1.8rem;">Your Results</h3>';
    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';

    Object.entries(results).forEach(([category, data]) => {
      html += `
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px;">
          <h4 style="font-size: 1.2rem; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 10px;">${category}</h4>
          <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 0.95rem;">
            <span>Your ${cpiData.reportMonth} spending:</span>
            <span style="font-weight: 700;">$${data.current.toFixed(2)}</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 0.95rem;">
            <span>Cost in ${cpiData.previousMonth}:</span>
            <span style="font-weight: 700;">$${data.lastMonth.toFixed(2)}</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 0.95rem;">
            <span>Cost in ${cpiData.previousYear}:</span>
            <span style="font-weight: 700;">$${data.lastYear.toFixed(2)}</span>
          </div>
          <div style="border-top: 1px solid rgba(255,255,255,0.3); margin-top: 10px; padding-top: 10px; display: flex; justify-content: space-between; font-size: 0.85rem;">
            <span>Monthly: ${data.monthlyChange > 0 ? '+' : ''}${data.monthlyChange}%</span>
            <span>Annual: ${data.annualChange > 0 ? '+' : ''}${data.annualChange}%</span>
          </div>
        </div>
      `;
    });

    html += '</div>';
    resultsDiv.innerHTML = html;
  }

  async function submitEmail() {
    const email = document.getElementById('emailInput').value;
    
    if (!email || !email.includes('@')) {
      alert('Please enter a valid email address');
      return;
    }

    try {
      const response = await fetch('https://api.web3forms.com/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          access_key: 'YOUR_WEB3FORMS_ACCESS_KEY',
          subject: 'New Email Signup - Price Inflation Report',
          from_name: 'Price Inflation Report',
          email: email,
          message: `New email signup: ${email}`
        })
      });

      const result = await response.json();
      
      if (result.success) {
        alert(`Thank you! We'll notify you at ${email} when the next Price Inflation Report is released.`);
        document.getElementById('emailInput').value = '';
      } else {
        alert('There was an error. Please try again.');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('There was an error. Please try again.');
    }
  }

  async function submitSurvey() {
    // Get form values
    const zipcode = document.getElementById('survey_zipcode').value;
    const spendingChange = document.getElementById('survey_spending_change').value;
    const categoryIncrease = document.getElementById('survey_category_increase').value;
    const coverExpenses = document.getElementById('survey_cover_expenses').value;
    const priceExpectations = document.getElementById('survey_price_expectations').value;

    // Validate required fields
    if (!zipcode) {
      alert('Please enter your ZIP code');
      return;
    }

    if (!spendingChange || !categoryIncrease || !coverExpenses || !priceExpectations) {
      alert('Please answer all questions');
      return;
    }

    try {
      const response = await fetch('https://api.web3forms.com/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          access_key: 'YOUR_WEB3FORMS_ACCESS_KEY',
          subject: `Inflation Survey Response - ZIP ${zipcode}`,
          from_name: 'Price Inflation Report',
          message: `
Report Month: ${cpiData.reportMonth}
ZIP Code: ${zipcode}
Timestamp: ${new Date().toISOString()}

Survey Responses:

Q1. ZIP Code: ${zipcode}

Q2. Compared to last month, how did your total spending change due to price changes?
Answer: ${spendingChange}

Q3. As a result of price changes, which category's spending increased the most for you this month?
Answer: ${categoryIncrease}

Q4. Given your recent monthly income and price changes, can you cover your monthly expenses?
Answer: ${coverExpenses}

Q5. Over the next 3 months, do you expect prices in general will go up, go down, or stay where they are now?
Answer: ${priceExpectations}
          `
        })
      });

      const result = await response.json();
      
      if (result.success) {
        alert('Thank you for sharing your perspective! Your responses help us understand how inflation affects real Americans.');
        // Clear form
        document.getElementById('survey_zipcode').value = '';
        document.getElementById('survey_spending_change').value = '';
	document.getElementById('survey_category_increase').value = '';
        document.getElementById('survey_cover_expenses').value = '';
        document.getElementById('survey_price_expectations').value = '';
      } else {
        alert('There was an error. Please try again.');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('There was an error. Please try again.');
    }
  }
</script>

<style>
  /* Responsive adjustments */
  #inflationChart {
    width: 100%;
    max-width: 100%;
    overflow-x: hidden;
  }

  /* Mobile default (stacked) */
  #expenseForm {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  /* Desktop layout */
  @media (min-width: 1024px) {
    #expenseForm {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
    }

    .expense-item[data-category="All Items"] {
      grid-column: 1 / -1;
    }
  }
</style>
